FWD_START_TEST([ipset entry overlap detect perf])
AT_KEYWORDS(ipset gh881)

dnl build a large ipset
dnl
AT_DATA([./deny_cidr], [])
NS_CHECK([sh -c '
for I in $(seq 10); do
  for J in $(seq 250); do
    echo "10.${I}.${J}.0/24" >> ./deny_cidr
  done
done
'])

dnl verify non-overlapping does not error
dnl
FWD_CHECK([--permanent --new-ipset=deny_set --type=hash:net --option=family=inet --option=hashsize=16384 --option=maxelem=20000], 0, [ignore])
NS_CHECK([time timeout 300 firewall-cmd --permanent --ipset=deny_set --add-entries-from-file=./deny_cidr], 0, [ignore], [ignore])

dnl verify overlap detection actually detects an overlap
dnl
NS_CHECK([echo "10.1.0.0/16" >> ./deny_cidr])
NS_CHECK([time timeout 300 firewall-cmd --permanent --ipset=deny_set --add-entries-from-file=./deny_cidr], 136, [ignore], [ignore])

FWD_END_TEST()
